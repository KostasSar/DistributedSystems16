package servlets;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

/**
 * Servlet implementation class CustomerRegisterServlet
 */
@WebServlet("/CustomerRegisterServlet")
public class CustomerRegisterServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse
	 *      response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response)
			throws ServletException, IOException {

		// allow access only if cookie exists
		Cookie[] cookies = request.getCookies();
		String userName = null;
		String department = null;
		if (cookies != null) {
			for (Cookie cookie : cookies) {
				if (cookie.getName().equals("userName")) {
					userName = cookie.getValue();
				}
				if (cookie.getName().equals("userDepartment")) {
					department = cookie.getValue();
				}

			}
		}

		if (userName == null) {
			response.sendRedirect("Login.html");
		} else {
			HttpSession session = request.getSession();
			// Receives data from form
			String customerName = request.getParameter("cuname");
			String customerSurname = request.getParameter("cusurname");
			String customerTRN = request.getParameter("cuTRN");
			String customerPhone = request.getParameter("cuphone");
			Long ctrn = Long.parseLong(customerTRN);
			Long cphone = Long.parseLong(customerPhone, 10);
			int store = Integer.parseInt(department);
		
			Connection con = (Connection) getServletContext().getAttribute("DBConnection");
			PreparedStatement ps = null;

			try {
				ps = con.prepareStatement(
						"INSERT INTO CUSTOMER  (Name,Surname,TRN,Phone_Number,Store_Id) VALUES (?,?,?,?,?)");
				ps.setString(1, customerName);
				ps.setString(2, customerSurname);
				ps.setLong(3, ctrn);
				ps.setLong(4, cphone);
				ps.setInt(5, store);
				ps.executeUpdate();
			} catch (SQLException e) {
				e.printStackTrace();

			}
			// Input data is stored in session for later use
			session.setAttribute("customerName", customerName);
			session.setAttribute("customerSurname", customerSurname);
			session.setAttribute("customerTRN", customerTRN);
			session.setAttribute("customerPhone", customerPhone);

			RequestDispatcher rd = getServletContext().getRequestDispatcher("/Carform.html");
			PrintWriter out = response.getWriter();
			out.println("<html><body>");
			out.println("<h1>Session still valid!</h1>");
			out.println("</body></html>");
			rd.include(request, response);

		}

	}
}
